<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    #{include file="../../Common/Header.html"}
</head>
<body>
<!-- loader Start -->
#{include file="../../Common/Loader.html"}
<!-- loader END -->
<!-- Wrapper Start -->
<div class="wrapper">
    <!-- Sidebar  -->
    #{include file="../../Common/Sidebar.html"}
    <!-- TOP Nav Bar -->
    #{include file="../../Common/TopBar.html"}
    <!-- TOP Nav Bar END -->
    <!-- Responsive Breadcrumb End-->
    <!-- Page Content  -->
    <div id="content-page" class="content-page">
        <div class="container-fluid">
            #{if !$business}
            <div class="row">
                <div class="col-sm-12">
                    <div class="iq-card iq-card-block iq-card-stretch iq-card-height">
                        <div class="iq-card-body">
                            <div class="iq-advance-course d-flex align-items-center justify-content-between">
                                <div class="left-block">
                                    <div class="d-flex align-items-center">
                                        <img src="#{$static}/Assets/images/page-img/35.png" class="img-fluid"
                                             alt="icon-img">
                                        <div class=" ml-3">
                                            <h4 class="">发现您还没有开通店铺。</h4>
                                            <p class="mb-0">开通您第一个店铺享受更多权益。</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            #{/if}
            #{if $purchase == 1}
            <div class="row">
                <div class="col-sm-12">
                    <div class="iq-card iq-card-block iq-card-stretch iq-card-height">
                        <div class="iq-card-body">
                            <div class="iq-advance-course d-flex align-items-center justify-content-between">
                                <div class="left-block">
                                    <div class="d-flex align-items-center">
                                        <img src="#{$static}/Assets/images/page-img/35.png" class="img-fluid"
                                             alt="icon-img">
                                        <div class=" ml-3">
                                            <h4 class="">您已经存在一个店铺了哦,可以尝试升级店铺来提高更多的权益。</h4>
                                            <p class="mb-0">升级更高的店铺等级,资源货架更加划算~!</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="right-block position-relativ">
                                    #{if $purchase == 1}<a href="/user/business/index" class="btn btn-primary">返回店铺</a>#{/if}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            #{/if}

            <div class="row">
                #{if !$business || $purchase == 1 && $business}
                #{foreach $level as $le}
                <div class="col-lg-3">
                    <div class="card bg-dark text-white text-center iq-mb-3">
                        <img src="#{$static}/Assets/images/page-img/25.jpg" style="height: 500px"
                             class="card-img rounded" alt="#">
                        <div class="card-img-overlay">
                            <span class="font-size-16 text-uppercase">#{$le.name}</span>
                            <h2 class="mb-4 display-3 font-weight-bolder text-white">¥#{$le.price}</h2>
                            <ul class="list-unstyled line-height-4 mb-0 ">
                                <li>分站功能：#{if $le.substation == 1}<span style="color: #0bb358;">√</span>#{else}<span
                                        style="color: red;">×</span>#{/if}
                                </li>
                                <li>分站返佣：#{$le.accrual*100}%</li>
                                <li>独立域名：#{if $le.top_domain == 1}<span style="color: #0bb358;">√</span>#{else}<span
                                        style="color: red;">×</span>#{/if}
                                </li>
                                <li>供货权限：#{if $le.supplier == 1}<span style="color: #0bb358;">√</span>#{else}<span
                                        style="color: red;">×</span>#{/if}
                                </li>
                                <li>供货手续费：#{if $le.supplier == 1}#{$le.cost*100}%#{else}-#{/if}</li>
                            </ul>
                            <a class="btn btn-primary mt-5 payButton" data-id="#{$le.id}">#{if !$business}立即开通
                                #{/if}#{if $purchase == 1}立即升级#{/if}</a>
                        </div>
                    </div>
                </div>
                #{/foreach}
                <div class="card bg-primary text-white text-center col-sm-12 iq-mb-3">
                    <blockquote class="blockquote mb-0 card-body">
                        <p class="font-size-14">• 店铺介绍</p>
                        <footer class="blockquote-footer">
                            <small class="text-white">
                                分站返佣：当您开通分站店铺后，您在分站卖出去的主站商品，将会给您一定的佣
                            </small>
                        </footer>
                        <footer class="blockquote-footer">
                            <small class="text-white">
                                顶级域名：当您开通分站后，可以绑定属于您自己的顶级域名，而不是使用分配的子域名
                            </small>
                        </footer>
                        <footer class="blockquote-footer">
                            <small class="text-white">
                                供货权限：可以建立自己的商品分类，以及添加自己的商品来进行售卖，主站也会帮你售卖
                            </small>
                        </footer>
                        <footer class="blockquote-footer">
                            <small class="text-white">
                                供货手续费：用作与您自主上架的商品，当成功出售时，系统将收取一定的手续费
                            </small>
                        </footer>
                    </blockquote>
                </div>
                #{else}
                #{if $user.businessLevel.substation == 1}
                <div class="col-sm-12">
                    <div class="iq-card iq-card-block iq-card-stretch iq-card-height">
                        <div class="iq-card-body">
                            <div class="iq-advance-course d-flex align-items-center justify-content-between">
                                <div class="left-block">
                                    <div class="d-flex align-items-center">
                                        <img src="#{$static}/Assets/images/page-img/35.png" class="img-fluid"
                                             alt="icon-img">
                                        <div class=" ml-3">
                                            <h4 class="">管理您的店铺</h4>
                                            <p class="mb-0">当前商户等级：<img src="#{$user.businessLevel.icon}"
                                                                        style="height: 16px;margin-top: -4px;">#{$user.businessLevel.name}，分站返佣：#{$user.businessLevel.accrual*100}%，绑定独立域名：#{if
                                                $user.businessLevel.top_domain == 1}<b style="color: green;">✔</b>#{else}<b
                                                        style="color: red;">✖</b>#{/if}，供货权限：#{if
                                                $user.businessLevel.supplier == 1}<b style="color: green;">✔</b>，供货手续费：#{$user.businessLevel.cost*100}%#{else}<b
                                                        style="color: red;">✖</b>#{/if} #{if
                                                count($level) > 0} <a href="/user/business/index?purchase=1"
                                                                      style="color: #a372d7;font-weight: bold;margin-left: 10px;">我要升级，变得更强！</a>#{/if}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-sm-12">

                    <div class="iq-card">
                        <div class="iq-card-header d-flex justify-content-between">
                            <div class="iq-header-title">
                                <h4 class="card-title">我的店铺</h4>
                            </div>
                        </div>
                        <div class="iq-card-body">
                            <!--                                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Morbi vulputate, ex ac venenatis mollis, diam nibh finibus leo</p>-->
                            <form class="form-data">
                                <div class="form-group">
                                    <label>店铺名称</label>
                                    <input class="form-control" value="#{$business.shop_name}" name="shop_name"
                                           required autocomplete="off" placeholder="请输入店铺名称">
                                </div>
                                <div class="form-group">
                                    <label>网站标题</label>
                                    <input class="form-control" value="#{$business.title}" name="title" required
                                           autocomplete="off" placeholder="用于显示浏览器标题">
                                </div>
                                <div class="form-group">
                                    <label>店铺公告</label>
                                    <textarea class="form-control" type="text" name="notice" required autocomplete="off"
                                              placeholder="店铺公告" style="color: #134afc;">#{$business.notice}</textarea>
                                </div>
                                <div class="form-group">
                                    <div class="custom-control custom-switch">
                                        <input type="checkbox" class="custom-control-input" value="1" id="customSwitch"
                                               name="master_display" #{if $business.master_display== 1}checked#{/if}>
                                        <label class="custom-control-label" for="customSwitch">显示主站商品[全局]</label>
                                    </div>
                                </div>

                                #{if $app.version > "0.8.0-beta"}
                                <div class="form-group">
                                    <label>主站分类
                                        <a href="javascript:void(0);" class="badge badge-primary category-show"
                                           data-state="1">全部显示</a>
                                        <a href="javascript:void(0);" class="badge badge-danger category-show"
                                           data-state="0">全部隐藏</a>
                                    </label>
                                    <div>
                                        <table id="master_category"></table>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>主站商品
                                        <a href="javascript:void(0);" class="badge badge-primary commodity-show"
                                           data-state="1">全部显示</a>
                                        <a href="javascript:void(0);" class="badge badge-danger commodity-show"
                                           data-state="0">全部隐藏</a>
                                        <a href="javascript:void(0);"
                                           class="badge badge-danger commodity-premium">加价</a>
                                    </label>
                                    <div>
                                        <table id="master_commodity"></table>
                                    </div>
                                </div>
                                #{/if}

                                <div class="form-group">
                                    <label>客服QQ</label>
                                    <input class="form-control" value="#{$business.service_qq}" name="service_qq"
                                           required autocomplete="off" placeholder="售后客服QQ">
                                </div>
                                <div class="form-group">
                                    <label>客服地址</label>
                                    <input class="form-control" value="#{$business.service_url}" name="service_url"
                                           autocomplete="off" placeholder="网页客服地址" style="color: #134afc;">
                                </div>
                                <div class="form-group">
                                    <label>子域名 #{if $business.subdomain} <b style="color: green;">✔</b> <a
                                            style="color: #239c87;" href="javascript:void(0);" class="unbind-subdomain">解绑</a>
                                        #{/if}</label>
                                    <input class="form-control" value="#{$business.subdomain}" name="subdomain"
                                           autocomplete="off" placeholder="前缀">
                                </div>
                                <div class="form-group">
                                    <select class="form-control" name="suffix" #{if $business.subdomain} disabled #{/if}>
                                    #{foreach $domain as $d}
                                    <option value="#{$d}">.#{$d}</option>
                                    #{/foreach}
                                    </select>
                                </div>
                                #{if $user.businessLevel.top_domain == 1}
                                <div class="form-group">
                                    <label>
                                        独立域名 #{if $business.topdomain} <a style="color: #239c87;"
                                                                          href="javascript:void(0);"
                                                                          class="unbind-topdomain">解绑</a> [#{if
                                        gethostbyname($config.cname) == gethostbyname($business.topdomain)}<b
                                            style="color: green;">正常</b>#{else}<b
                                            style="color: mediumvioletred;">未检测到解析</b>#{/if}] #{/if} <span
                                            style="color: red;">CNAME解析地址：<b style="color: green;">#{$config.cname}</b></span>
                                    </label>
                                    <input class="form-control" type="text" value="#{$business.topdomain}"
                                           name="topdomain"
                                           required autocomplete="off" placeholder="绑定独立域名"
                                           style="width:260px;color: #ff9191;" #{if $business.topdomain} disabled #{/if}>
                                </div>
                                #{/if}
                                <a href="javascript:void(0);" class="btn btn-primary text-white save-config">保存设置</a>
                            </form>
                        </div>
                    </div>
                </div>
                #{/if}
                #{/if}
            </div>
        </div>
    </div>
</div>
<!-- Wrapper END -->
<!-- Footer -->
#{include file="../../Common/Footer.html"}

<script>
    layui.define(['layer', 'hex'], () => {
        var table = layui.table
            , form = layui.form
            , util = layui.util
            , cao = layui.hex
            , $ = layui.$;

        let globalCategoryId = 0;
        let globalCategoryName = null;

        var categoryTable = table.render({
            elem: '#master_category',
            method: "post",
            url: '/user/api/master/category',
            page: true, //开启分页
            parseData: (res) => {
                if (res.code === 200) {
                    return {
                        "code": 0,
                        "msg": res.msg,
                        "count": res.count,
                        "data": res.data
                    };
                }
            },
            cols: [
                [
                    {field: 'name', title: '主站名称'},
                    {
                        field: 'status', title: '状态', templet: function (item) {
                            if (!item.user_category || item.user_category.status == 1) {
                                return '<span class="badge border border-success text-success category-status" style="cursor:pointer;" data-id="' + item.id + '">显示</span>';
                            }
                            return '<span class="badge border border-danger text-danger category-status" style="cursor:pointer;" data-id="' + item.id + '">隐藏</span>';
                        }
                    },
                    {
                        field: 'user_name', title: '自定义名称', templet: function (item) {
                            if (!item.user_category || !item.user_category.name) {
                                return '-';
                            }
                            return item.user_category.name;
                        }
                    },
                    {
                        title: '', width: 180, templet: function (item) {
                            return `<a href="javascript:void(0)" data-id="` + item.id + `" class="badge border border-primary text-primary category-check">查看商品</a>
                                    <a href="javascript:void(0)" data-id="` + item.id + `" class="badge border border-primary text-primary category-settings">设置分类</a>`;
                        }
                    },
                ]
            ],
            done: (res) => {
                table.render();
                cao.setIdMap(res.data);

                $('.category-status').click(function () {
                    let row = cao.getMapItem($(this).attr('data-id'));

                    let values = row.user_category;

                    if (!values) {
                        values = {id: 0, category_id: row.id};
                    }

                    User.$post("/user/api/master/setCategoryStatus", values, res => {
                        layer.msg("已生效");
                        categoryTable.reload();
                    });
                });

                $('.category-check').click(function () {
                    let row = cao.getMapItem($(this).attr('data-id'));
                    globalCategoryId = row.id;
                    globalCategoryName = row.name;

                    commodityTable.reload({
                        where: {category_id: row.id},
                        page: {
                            curr: 1
                        }
                    }, false);
                });

                $('.category-settings').click(function () {
                    let row = cao.getMapItem($(this).attr('data-id'));
                    let values = row.user_category;
                    if (!values) {
                        values = {category_id: row.id};
                    }
                    setCategory(values);
                });
            }
        });

        let setCategory = (values = {}) => {
            cao.popup('/user/api/master/setCategory', [
                {title: "cid", name: "category_id", type: "hidden"},
                {title: "自定义名称", name: "name", type: "input", placeholder: "自定义分类名称，不填写代表使用主站的"},
                {title: "状态", name: "status", type: "switch", text: "显示"}
            ], res => {
                categoryTable.reload();
            }, values, "480px")
        }

        $('.category-show').click(function () {
            let status = $(this).attr("data-state");
            User.$post("/user/api/master/setCategoryAllStatus", {status: status}, res => {
                layer.msg("已生效");
                categoryTable.reload();
            });
        });

        var commodityTable = table.render({
            elem: '#master_commodity',
            method: "post",
            url: '/user/api/master/commodity',
            page: true, //开启分页
            parseData: (res) => {
                if (res.code === 200) {
                    return {
                        "code": 0,
                        "msg": res.msg,
                        "count": res.count,
                        "data": res.data
                    };
                }
            },
            cols: [
                [
                    {field: 'name', title: '名称'},
                    {field: 'price', title: '单价'},
                    {
                        field: 'status', title: '状态', templet: function (item) {
                            if (!item.user_commodity || item.user_commodity.status == 1) {
                                return '<span class="badge border border-success text-success commodity-status" style="cursor:pointer;" data-id="' + item.id + '">显示</span>';
                            }
                            return '<span class="badge border border-danger text-danger commodity-status" style="cursor:pointer;" data-id="' + item.id + '">隐藏</span>';
                        }
                    },
                    {
                        field: 'user_name', title: '自定义名称', templet: function (item) {
                            if (!item.user_commodity || !item.user_commodity.name) {
                                return '-';
                            }
                            return item.user_commodity.name;
                        }
                    },
                    {
                        field: 'premium', title: '加价', templet: function (item) {
                            if (!item.user_commodity || item.user_commodity.premium == 0) {
                                return '-';
                            }
                            return item.user_commodity.premium;
                        }
                    },
                    {
                        title: '', width: 120, templet: function (item) {
                            return `<a href="javascript:void(0)" data-id="` + item.id + `" class="badge border border-primary text-primary commodity-settings">商品设置</a>`;
                        }
                    },
                ]
            ],
            done: (res) => {
                table.render();
                cao.setIdMap(res.data);

                $('.commodity-status').click(function () {
                    let row = cao.getMapItem($(this).attr('data-id'));

                    let values = row.user_commodity;

                    if (!values) {
                        values = {id: 0, commodity_id: row.id};
                    }

                    User.$post("/user/api/master/setCommodityStatus", values, res => {
                        layer.msg("已生效");
                        commodityTable.reload();
                    });
                });

                $('.commodity-settings').click(function () {
                    let row = cao.getMapItem($(this).attr('data-id'));
                    let values = row.user_commodity;
                    if (!values) {
                        values = {commodity_id: row.id};
                    }
                    setCommodity(values);
                });
            }
        });

        let setCommodity = (values = {}) => {
            cao.popup('/user/api/master/setCommodity', [
                {title: "cid", name: "commodity_id", type: "hidden"},
                {title: "自定义名称", name: "name", type: "input", placeholder: "自定义商品名称，不填写代表使用主站的"},
                {title: "加价", name: "premium", type: "input", placeholder: "商品加价"},
                {title: "状态", name: "status", type: "switch", text: "显示"}
            ], res => {
                commodityTable.reload();
            }, values, "480px");
        }

        $('.commodity-show').click(function () {
            let status = $(this).attr("data-state");
            User.$post("/user/api/master/setCommodityAllStatus", {
                status: status,
                category_id: globalCategoryId
            }, res => {
                layer.msg("已生效");
                commodityTable.reload();
            });
        });

        $('.commodity-premium').click(function () {
            cao.popup('/user/api/master/setCommodityAllPremium', [
                {
                    title: "加价模式", name: "mode", type: "radio", dict: [
                        {id: 0, name: "普通金额加价"},
                        {id: 1, name: "百分比加价"}
                    ], default: 0
                },
                {title: "加价数量", name: "premium", type: "input", placeholder: "金额/百分比(小数代替)"},
                {title: "cid", name: "category_id", type: "hidden"}
            ], res => {
                commodityTable.reload();
            }, {category_id: globalCategoryId}, "480px", false, "加价" + (globalCategoryName ? " - <b style='color:red;'>仅分类：" + globalCategoryName + "</b>" : " - 全部"));
        });

        $('.payButton').click(function () {
            var levelId = $(this).attr('data-id');
            console.log(levelId);
            layer.confirm('您是否要开通该店铺~', {
                btn: ['开通', '取消']
            }, function () {
                User.$post("/user/api/business/purchase", {
                    levelId: levelId
                }, res => {
                    layer.msg("开通成功");
                    window.location.href = "/user/business/index";
                })
            });
        });

        $('.save-config').click(() => {
            User.$post("/user/api/business/saveConfig", $('.form-data').serialize(), res => {
                layer.msg("保存成功");
            })
        });

        $(function () {
            layui.use(['form'], function () {
                var form = layui.form;
                $('.unbind-subdomain').click(function () {
                    layer.confirm('您正在解绑子域名，解绑后，用户将无法再通过旧子域名访问您的店铺。', {
                        btn: ['解绑', '取消'],
                        title: "解绑子域名"
                    }, function () {
                        User.$post("/user/api/business/unbind", {type: 0}, res => {
                            layer.msg("解绑成功");
                            setTimeout(() => {
                                window.location.reload()
                            }, 500);
                        })
                    });
                });
                $('.unbind-topdomain').click(function () {
                    layer.confirm('您正在解绑独立域名，解绑后，用户将无法再通过独立域名访问您的店铺。', {
                        btn: ['解绑', '取消'],
                        title: "解绑独立域名"
                    }, function () {
                        User.$post("/user/api/business/unbind", {type: 1}, res => {
                            layer.msg("解绑成功");
                            setTimeout(() => {
                                window.location.reload()
                            }, 500);
                        })
                    });
                });
            });
        });
    })
    ;
</script>
</body>
</html>