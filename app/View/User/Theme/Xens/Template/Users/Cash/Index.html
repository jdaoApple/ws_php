<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    #{include file="../../Common/Header.html"}
</head>
<body>
<!-- loader Start -->
#{include file="../../Common/Loader.html"}
<!-- loader END -->
<!-- Wrapper Start -->
<div class="wrapper">
    <!-- Sidebar  -->
    #{include file="../../Common/Sidebar.html"}
    <!-- TOP Nav Bar -->
    #{include file="../../Common/TopBar.html"}
    <!-- TOP Nav Bar END -->
    <!-- Responsive Breadcrumb End-->
    <!-- Page Content  -->
    <div id="content-page" class="content-page">
        <div class="container-fluid">
            <div class="row">
                <div class="col-sm-12 col-lg-12">
                    <div class="alert bg-white alert-primary" role="alert">
                        <div class="iq-alert-text">
                            最低兑现金额：<b>#{$config.cash_min}元</b>，手动提现费用：<b>#{$config.cash_cost}元</b> (每天12点自动结算免费)
                        </div>
                    </div>
                </div>
            </div>
            <div class="row">

                <div class="col-sm-4 col-lg-4">
                    <div class="iq-card">
                        <div class="iq-card-header d-flex justify-content-between">
                            <div class="iq-header-title">
                                <h4 class="card-title">兑现方式</h4>
                            </div>
                        </div>

                        <div class="iq-card-body">
                            <ul class="list-inline p-0 m-0 pay-list">
                                #{if $config.cash_type_alipay == 1}
                                <li class="d-flex mb-3 align-items-center p-3 sell-list rounded border-primary"
                                    onclick="payClick(this,0)">
                                    <div class="user-img img-fluid">
                                        <img src="/assets/user/images/cash/alipay.png" alt="story-img"
                                             class="img-fluid rounded-circle avatar-40">
                                    </div>
                                    <div class="media-support-info ml-3">
                                        <h6>支付宝</h6>
                                    </div>
                                    <div class="iq-card-header-toolbar d-flex align-items-center">
                                        <div class="badge badge-pill badge-primary">AliPay</div>
                                    </div>
                                </li>
                                #{/if}
                                #{if $config.cash_type_wechat == 1}
                                <li class="d-flex mb-3 align-items-center p-3 sell-list rounded"
                                    onclick="payClick(this,1)">
                                    <div class="user-img img-fluid">
                                        <img src="/assets/user/images/cash/wechat.png" alt="story-img"
                                             class="img-fluid rounded-circle avatar-40">
                                    </div>
                                    <div class="media-support-info ml-3">
                                        <h6>微信</h6>
                                    </div>
                                    <div class="iq-card-header-toolbar d-flex align-items-center">
                                        <div class="badge badge-pill badge-primary">Wechat</div>
                                    </div>
                                </li>
                                #{/if}
                            </ul>
                        </div>
                    </div>
                    <div class="iq-card">
                        <div class="iq-card-header d-flex justify-content-between">
                            <div class="iq-header-title">
                                <h4 class="card-title">兑现硬币</h4>
                            </div>
                        </div>

                        <div class="iq-card-body">
                            <form class="form-horizontal">
                                <div class="form-group row">
                                    <label class="control-label col-sm-2 align-self-center mb-0 col-md-5">用户名:</label>
                                    <div class="col-sm-10" style="color: #63b584;">
                                        <b>#{$user.username}</b>
                                    </div>
                                </div>
                                <div class="form-group row">
                                    <label class="control-label col-sm-2 align-self-center mb-0 col-md-5">拥有硬币:</label>
                                    <div class="col-sm-10" style="color: #63b584;">
                                        <b>#{$user.coin}个</b>
                                    </div>
                                </div>

                                <div class="form-group">
                                    <label for="amount">兑现硬币:</label>
                                    <input type="text" required
                                           value="#{$config.cash_min}" autocomplete="off"
                                           placeholder="请输入兑现数量~" name="amount" class="form-control" id="amount">
                                </div>
                                <div class="form-group">
                                    <div type="submit" class="btn btn-primary payButton">确定充值</div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>

                <div class="col-sm-8 col-lg-8">
                    <div class="iq-card">
                        <div class="iq-card-header d-flex justify-content-between">
                            <div class="iq-header-title">
                                <h4 class="card-title">兑现记录</h4>
                            </div>
                        </div>
                        <div class="iq-card-body">
                            <form class="search-query"></form>
                            <table id="cash"></table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Wrapper END -->
<!-- Footer -->
#{include file="../../Common/Footer.html"}

<script>

    var payId = 0;

    function payClick(obj, id) {
        $('.border-primary').removeClass('border-primary');
        $(obj).addClass('border-primary');
        payId = id;
    }


    layui.define(['layer', 'hex'], function () {
        var table = layui.table
            , form = layui.form
            , util = layui.util
            , cao = layui.hex
            , $ = layui.$;

        let type = ['<span style="color: #0C84D1;">自动结算</span>', '<span style="color: #e8a430;">手动兑现</span>'];
        let card = ['<span class="badge badge-primary">支付宝</span>', '<span class="badge badge-success">微信</span>'];
        let status = ['<span class="badge border border-info text-info">银行处理中</span>', '<span  class="badge border border-success text-success">已到账</span>', '<span  class="badge border border-warning text-warning">失败：[msg]</span>'];

        var tableIns = table.render({
            elem: '#cash',
            method: "post",
            url: '/user/api/cash/record',
            page: true, //开启分页
            parseData: (res) => {
                if (res.code === 200) {
                    return {
                        "code": 0,
                        "msg": res.msg,
                        "count": res.count,
                        "data": res.data
                    };
                }
            },
            cols: [
                [
                    {
                        field: 'amount', title: '硬币', templet: function (item) {
                            return '<b style="color: green;">￥' + item.amount + '</b>';
                        }
                    },
                    {
                        field: 'type', title: '类型', templet: function (item) {
                            return type[item.type];
                        }
                    },
                    {
                        field: 'card', title: '到账方式', templet: function (item) {
                            return card[item.card];
                        }
                    },
                    {
                        field: 'status', title: '状态', templet: function (item) {
                            return status[item.status].replace("[msg]", item.message);
                        }
                    },
                    {
                        field: 'cost', title: '手续费', templet: function (item) {
                            return '<span style="color: #13c2b3;">' + item.cost + '</span>';
                        }
                    },
                    {
                        field: 'create_time', title: '提交时间'
                    },
                    {
                        field: 'arrive_time', title: '到账时间', templet: function (item) {
                            if (!item.arrive_time) {
                                return "-";
                            }
                            return item.arrive_time;
                        }
                    }
                ]
            ],
            done: (res) => {
                table.render();
                cao.setIdMap(res.data);
            }
        });

        $('.payButton').click(function () {
            layer.confirm('兑现' + $('input[name=amount]').val() + "硬币需要#{$config.cash_cost}元手续费，您确定吗？", {
                btn: ['确认', '取消']
            }, function () {
                User.$post("/user/api/cash/submit", {
                    type: payId,
                    amount: $('input[name=amount]').val()
                }, res => {
                    layer.msg("兑现成功，请耐心等待到账。")
                    tableIns.reload();
                });
            });
        });

        cao.query('.search-query', table, [
            {
                title: "到账方式", name: "equal-card", type: "select", dict: [
                    {id: 0, name: "支付宝"},
                    {id: 1, name: "微信"},
                ]
            }, {
                title: "状态", name: "equal-status", type: "select", dict: [
                    {id: 0, name: "处理中"},
                    {id: 1, name: "成功"},
                    {id: 2, name: "失败"},
                ]
            },
            {title: "开始时间", name: "betweenStart-create_time", type: "date"},
            {title: "结束时间", name: "betweenEnd-create_time", type: "date"},
        ], true, false, (res) => {
            tableIns.reload({
                where: res,
                page: {
                    curr: 1
                }
            }, false);
        });
    });

</script>
</body>
</html>